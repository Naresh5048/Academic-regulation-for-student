<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Notice Agent | LBRCE</title>
    <!-- Tailwind Play CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        lbrce: {
                            blue: "#1e3a8a",
                            gold: "#fbbf24",
                        }
                    }
                }
            }
        }
    </script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }
    </style>
</head>

<body class="bg-slate-900 overflow-hidden">
    <div id="root"></div>

    <!-- React and Babel for JSX -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Axios -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const API_BASE = "http://localhost:8000";

        // Simple Icon Component since Lucide-React UMD is tricky
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        function App() {
            const [messages, setMessages] = useState([
                { role: 'bot', content: "Hello! I'm your Official LBRCE Assistant. How can I help you with campus notices today?" }
            ]);
            const [input, setInput] = useState("");
            const [loading, setLoading] = useState(false);
            const [syncing, setSyncing] = useState(false);
            const [status, setStatus] = useState("Checking...");
            const chatEndRef = useRef(null);

            const scrollToBottom = () => {
                chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            useEffect(() => {
                scrollToBottom();
                if (window.lucide) window.lucide.createIcons();
            }, [messages]);

            useEffect(() => {
                checkStatus();
            }, []);

            const checkStatus = async () => {
                try {
                    const res = await axios.get(`${API_BASE}/status`);
                    setStatus(res.data.status === "online" ? "System Ready" : "System Error");
                } catch (err) {
                    setStatus("Offline");
                }
            };

            const handleSend = async (e) => {
                e.preventDefault();
                if (!input.trim()) return;

                const userMessage = { role: 'user', content: input };
                setMessages(prev => [...prev, userMessage]);
                setInput("");
                setLoading(true);

                try {
                    const response = await axios.post(`${API_BASE}/chat`, { question: input });
                    setMessages(prev => [...prev, { role: 'bot', content: response.data.answer }]);
                } catch (error) {
                    setMessages(prev => [...prev, { role: 'bot', content: "Error: Unable to reach the server. Please ensure the backend (Python) is running." }]);
                } finally {
                    setLoading(false);
                }
            };

            const handleSync = async () => {
                setSyncing(true);
                try {
                    const response = await axios.get(`${API_BASE}/sync`);
                    alert(response.data.message);
                } catch (error) {
                    alert("Failed to sync documents. Check the backend logs.");
                } finally {
                    setSyncing(false);
                }
            };

            return (
                <div className="flex h-screen bg-slate-900 text-slate-100 overflow-hidden font-sans">
                    {/* Sidebar */}
                    <aside className="w-72 bg-slate-800 border-r border-slate-700 flex flex-col p-6 shadow-2xl">
                        <div className="flex items-center gap-3 mb-10 pb-6 border-b border-slate-700">
                            <div className="p-2 bg-blue-600 rounded-lg shadow-lg shadow-blue-500/20">
                                <Icon name="layout-dashboard" size={24} className="text-white" />
                            </div>
                            <h1 className="text-xl font-bold tracking-tight">LBRCE Agent</h1>
                        </div>

                        <nav className="flex-1 space-y-4">
                            <div className="p-4 bg-slate-700/50 rounded-xl border border-slate-600/50">
                                <div className="flex items-center gap-2 mb-3 text-xs font-semibold text-slate-400 uppercase tracking-widest text-[10px]">
                                    <Icon name="server" size={14} />
                                    System Status
                                </div>
                                <div className="flex items-center gap-2">
                                    <div className={`h-2.5 w-2.5 rounded-full ${status === 'System Ready' ? 'bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]' : 'bg-rose-500 animate-pulse'}`}></div>
                                    <span className="text-sm font-medium">{status}</span>
                                </div>
                            </div>

                            <button
                                onClick={handleSync}
                                disabled={syncing}
                                className="w-full flex items-center justify-between p-4 bg-blue-600 hover:bg-blue-500 disabled:opacity-50 text-white rounded-xl transition-all duration-300 shadow-lg shadow-blue-900/20 group"
                            >
                                <div className="flex items-center gap-2">
                                    <Icon name="refresh-cw" size={18} className={syncing ? "animate-spin" : ""} />
                                    <span className="font-semibold">Sync Now</span>
                                </div>
                                {syncing && <span className="text-[10px] font-light opacity-80 italic">Syncing...</span>}
                            </button>
                        </nav>

                        <div className="mt-auto p-4 bg-slate-700/30 rounded-xl border border-dashed border-slate-600">
                            <p className="text-[10px] text-slate-400 leading-relaxed">
                                Assumption: If year is missing, current year is <span className="text-blue-400 font-bold">2026</span>.
                            </p>
                        </div>
                    </aside>

                    {/* Main Chat Area */}
                    <main className="flex-1 flex flex-col relative bg-[radial-gradient(circle_at_top_right,_var(--tw-gradient-stops))] from-slate-900 via-slate-900 to-slate-800">
                        {/* Header */}
                        <header className="h-20 bg-slate-900/50 backdrop-blur-md border-b border-slate-700/50 flex items-center justify-between px-10 z-10 sticky top-0">
                            <div className="flex items-center gap-2">
                                <Icon name="message-square" size={20} className="text-blue-400" />
                                <h2 className="text-lg font-semibold">Campus Bot Chat</h2>
                            </div>
                            <div className="text-[10px] text-slate-500 font-mono flex items-center gap-2 uppercase tracking-wide">
                                Engine: <span className="text-blue-500 px-2 py-1 bg-blue-500/10 rounded border border-blue-500/20">Groq + Llama 3.3</span>
                            </div>
                        </header>

                        {/* Scrollable Messages */}
                        <div className="flex-1 overflow-y-auto px-6 py-10 space-y-8 scroll-smooth">
                            {messages.map((msg, i) => (
                                <div
                                    key={i}
                                    className={`flex items-start gap-4 max-w-4xl mx-auto animate-in fade-in slide-in-from-bottom-2 duration-300 ${msg.role === 'user' ? 'flex-row-reverse' : ''}`}
                                >
                                    <div className={`p-3 rounded-2xl shadow-xl shrink-0 ${msg.role === 'user' ? 'bg-blue-600 shadow-blue-900/20' : 'bg-slate-700 shadow-black/20'}`}>
                                        {msg.role === 'user' ? <Icon name="user" size={20} /> : <Icon name="bot" size={20} className="text-blue-400" />}
                                    </div>
                                    <div className="flex flex-col gap-2 group max-w-[80%]">
                                        <span className={`text-[10px] font-bold tracking-widest uppercase text-slate-500 ${msg.role === 'user' ? 'text-right' : ''}`}>
                                            {msg.role === 'user' ? 'Student' : 'Campus Bot'}
                                        </span>
                                        <div className={`px-6 py-4 rounded-3xl text-sm leading-relaxed shadow-sm ${msg.role === 'user'
                                                ? 'bg-blue-600/10 text-blue-50 border border-blue-500/20 rounded-tr-sm self-end'
                                                : 'bg-slate-800/80 text-slate-200 border border-slate-700/50 rounded-tl-sm'
                                            }`}>
                                            {msg.content}
                                        </div>
                                    </div>
                                </div>
                            ))}
                            {loading && (
                                <div className="flex items-start gap-4 max-w-4xl mx-auto animate-pulse">
                                    <div className="p-3 rounded-2xl bg-slate-700">
                                        <Icon name="bot" size={20} className="text-blue-400" />
                                    </div>
                                    <div className="flex flex-col gap-2">
                                        <span className="text-[10px] font-bold tracking-widest uppercase text-slate-500">Campus Bot</span>
                                        <div className="px-6 py-4 rounded-3xl bg-slate-800 text-slate-400 border border-slate-700 rounded-tl-sm text-sm">
                                            Analyzing documents with Groq...
                                        </div>
                                    </div>
                                </div>
                            )}
                            <div ref={chatEndRef} />
                        </div>

                        {/* Input area */}
                        <div className="p-10 bg-gradient-to-t from-slate-900 via-slate-900/90 to-transparent">
                            <form
                                onSubmit={handleSend}
                                className="max-w-4xl mx-auto relative group"
                            >
                                <input
                                    type="text"
                                    value={input}
                                    onChange={(e) => setInput(e.target.value)}
                                    placeholder="Ask about holiday lists, deadlines, or events..."
                                    className="w-full bg-slate-800/50 backdrop-blur-sm border-2 border-slate-700 focus:border-blue-500 focus:outline-none focus:ring-4 focus:ring-blue-500/10 rounded-full py-5 px-8 pr-16 transition-all duration-300 text-lg shadow-2xl placeholder:text-slate-500 placeholder:font-light"
                                />
                                <button
                                    type="submit"
                                    disabled={loading || !input.trim()}
                                    className="absolute right-3 top-3 bottom-3 aspect-square bg-blue-600 hover:bg-blue-500 disabled:opacity-30 text-white rounded-full flex items-center justify-center transition-all duration-300 active:scale-95 shadow-lg shadow-blue-500/40"
                                >
                                    <Icon name="send" size={20} className={loading ? "animate-ping" : ""} />
                                </button>
                            </form>
                            <p className="text-center text-[10px] text-slate-500 mt-6 flex items-center justify-center gap-1.5 opacity-60">
                                <Icon name="info" size={12} /> Powered by Groq • Llama 3.3 70B • Vector Retrieval
                            </p>
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>